# fdsmp

Ein Filter-Skript, das IMAP-E-Mails nach Vorgabe mit einem lokalen LLM analysiert und verschiebt.

![fdsmp output](./images/fdsmp_output.jpg)

## Features

- **3-Phasen Offline-Architektur**: FETCH â†’ CLASSIFY â†’ MOVE (verhindert IMAP-Timeouts)
- **LangChain Few-Shot Examples**: LLM-gestÃ¼tzte Spam-Erkennung mit Beispielen
- **Batch Processing**: Effiziente Verarbeitung mehrerer Emails
- **Debug-Modi**: Logging- und Debugging-Optionen
- **Dry-Run Modus**: Sicheres Testen ohne Email-Manipulation

## Anlass

Mein E-Mail-Provider patzt bei der Spamerkennung. Je "grÃ¶ÃŸer" der Versender, desto weniger funktioniert das manuelle Spam-Training.
Werbung von AliExpress kommt praktisch immer durch. Dabei hat natÃ¼rlich nichts mit irgendetwas zu tun.
Zur Rettung herbei eilt ein Raspberry 5 mit 8 GB RAM und Vibe-Coding.

Die Frage nach dem Sinn von LLM-Inferenz auf einem Raspberry Pi ist erlaubt, denn schnell lÃ¤uft das Ganze sicher nicht.
Aktuell verwende ich [Qwen3-4B-Instruct-2507-GGUF:Q4_K_M](https://huggingface.co/unsloth/Qwen3-4B-Instruct-2507-GGUF), welches ca. 4,6 GB RAM belegt
und fÃ¼r die Analyse einer E-Mail etwas lÃ¤nger als eine Minute braucht.

## Installation

### Python und Paketmanager

```bash
# Python 3.11+
sudo apt update && sudo apt install python3 python3-pip

# uv
curl -LsSf https://astral.sh/uv/install.sh | sh
# oder: pip install uv
```

### Ollama installieren und Modelle laden

```bash
# Ollama installieren
curl -fsSL https://ollama.ai/install.sh | sh

# Empfohlene LLMs laden
ollama pull qwen3:0.6b      # Schnell, 600 MB
ollama pull gemma3:1b       # Mittel, 815 MB  
ollama pull phi4-mini       # GroÃŸ, 2.5 GB (braucht 3.9 GB RAM)
```

### Repository-Setup

```bash
# Repository downloaden
git clone https://github.com/sabotrax/fdsmp.git fdsmp
cd fdsmp

# AbhÃ¤ngigkeiten installieren
uv sync

# Konfiguration aus Template erstellen
cp .env.template .env
```

### Skript konfigurieren

Mindestens IMAP und E-Mail-Ordner konfigurieren.

```bash
# IMAP Configuration
IMAP_SERVER=imap.gmail.com
IMAP_PORT=993
IMAP_USERNAME=your-email@gmail.com
IMAP_PASSWORD=your-app-password

# Email Folders
INBOX_FOLDER=INBOX
SPAM_FOLDER=SPAM

# Ollama Configuration
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=qwen3:0.6b

# Spam Classification
SPAM_EXAMPLES_FILE=spam_examples.json
LLM_TEMPERATURE=0.2
LLM_NUM_CTX=8192

# Processing Configuration
MAX_EMAILS_TO_PROCESS=3
MAIL_BODY_LENGTH=300
```

## Beispiel-Mails fÃ¼r LLM bereitstellen

### Spam-Klassifikation

Das System verwendet **typ 1/typ 2** zur Kennzeichnung, um LLM-Spam-Bias zu umgehen:
- **typ 1** = kein Spam/Ham
- **typ 2** = Spam

### Beispiel-Mails hinzufÃ¼gen

+ Spam und Ham sollten ca. gleich vertreten sein. Je unterschiedlicher, desto besser.
+ Die Liste sollte nicht riesig werden, weil sie bei der Analyse jeder E-Mail vom LLM verarbeitet werden muss.
+ Die LÃ¤nge des Prompts (Systemprompt + Beispiele + E-Mail) beeinflusst die Verarbeitungsgeschwindigkeit maÃŸgeblich.
+ Ein zu groÃŸes Prompt kann das Kontext-Fenster (KurzzeitgedÃ¤chtnis) des LLMs Ã¼berschreiten.

**E-Mails extrahieren:**

Das Skript zieht die neuesten 10 E-Mails und legt sie in `data/` ab.

```bash
uv run extract_emails.py --emails 10
```

**JSON-Snippets aus Dateien kopieren und zu `spam_examples.json` hinzufÃ¼gen:**

Die EintrÃ¤ge mÃ¼ssen nicht geordnet sein.

```json
{
  "examples": [
    {
      "email": "Subject: ðŸ”¥ Mega Sale Alert!\nFrom: spammer@example.com",
      "classification": "typ 2"
    },
    {
      "email": "Subject: Beleg fÃ¼r Ihre Zahlung\nFrom: PayPal <service@paypal.de>",
      "classification": "typ 1"
    }
  ]
}
```

### Hinweise zum Betrieb

Wenn die Liste lÃ¤nger wird, stÃ¶ÃŸt man schnell an die Grenzen des kleinsten Modells.
Anzeichen dafÃ¼r sind, dass das LLM falsch sortiert (selbst bei hoher Ãœbereinstimmung von Vorlage und E-Mail).

Abhilfe:
+ Die nicht-erkannte Mail an die erste Position der Beispiel-E-Mails setzen.
+ Die Liste verkleinern.
+ Ein anderes/grÃ¶ÃŸeres LLM wÃ¤hlen.
  Ich habe die besten Erfahrungen mit Qwen3 gemacht. 

Man muss zwischen Anforderung und Ressourcen wie GPU, CPU und RAM abwÃ¤gen.

### AusfÃ¼hrung

```bash
# Test (verschiebt keine E-Mails)
uv run main.py --dry-run --emails 5

# Debug-Modus fÃ¼r detaillierte Logs
uv run main.py --dry-run --debug --emails 3

# Normale AusfÃ¼hrung
uv run main.py --emails 3
```

## Verwendung

### Kommandozeilen-Optionen

```bash
uv run main.py [OPTIONS]

Optionen:
  --dry-run           E-Mails klassifizieren, aber nicht verschieben
  --debug             Debug-Logging fÃ¼r LLM-Klassifikation aktivieren  
  --debug-prompt      VollstÃ¤ndigen Prompt anzeigen (erweitert --debug)
  --emails N          Anzahl E-Mails verarbeiten (Ã¼berschreibt Wert aus .env)
  -h, --help          Hilfe anzeigen
```

## Cron Setup

### Alle 30 Minuten
```bash
crontab -e

# Diese Zeile hinzufÃ¼gen:
*/30 * * * * cd /PFAD_ANPASSEN/fdsmp && /PFAD_ANPASSEN/bin/uv run main.py >> fdsmp-cron.log 2>&1
```

**Wichtig:** Verwende absolute Pfade fÃ¼r `uv` und das Verzeichnis.

## Architektur

### 3-Phasen Offline-Processing

**Phase 1 - FETCH:**
- IMAP-Verbindung aufbauen
- E-Mails mit UID-basierten Operationen holen
- IMAP-Verbindung trennen

**Phase 2 - CLASSIFY (Offline):**
- LLM-Klassifikation
- Spam-Email UIDs sammeln

**Phase 3 - MOVE:**
- IMAP-Verbindung fÃ¼r Batch-Operation
- Robustes Error Handling fÃ¼r verschwundene E-Mails
- Detaillierte Success/Failure-Berichte

### Fehlerbehandlung

Das System behandelt folgende Fehler:
- **Verschwundene Emails**: User hat Email zwischenzeitlich verschoben
- **IMAP-Verbindungsfehler**: Netzwerkprobleme wÃ¤hrend Move-Phase
- **Spam-Ordner-Probleme**: Berechtigungen oder Speicherplatz

## Logging

### Log-Dateien (wachsen kontinuierlich)

- **`fdsmp.log`**: Hauptlog-Datei
- **`fdsmp-cron.log`**: Cron-AusfÃ¼hrungen (bei Cron-Setup)

## Troubleshooting

### HÃ¤ufige Probleme

**LLM antwortet nicht:**
```bash
# LLM-Verbindung testen
curl http://localhost:11434/api/version

# Model verfÃ¼gbar?
ollama list
```

**IMAP-Verbindung fehlschlÃ¤gt:**
```bash
# IMAP-Ordner testen
uv run debug_scripts/test_imap_folders.py
```

**Emails werden nicht verschoben:**
```bash
# Debug-Modus mit Prompt-Anzeige
uv run main.py --debug --debug-prompt --emails 1
```

**Emails falsch klassifiziert:**
- LLM zu klein â†’ grÃ¶ÃŸeres Modell verwenden
- Temperatur verÃ¤ndern in `.env` (LLM-Wissen erforderlich)
- LLM_NUM_CTX ausreichend? Das modell-spezifische Kontext-Fenster kÃ¶nnte durch ein zu groÃŸes Prompt (Prompt + Beispiele + E-Mail) Ã¼berschritten sein (LLM-Wissen erforderlich)

## Development

### Debug-Scripts

```bash
# IMAP-Ordner und Verbindung testen
uv run debug_scripts/test_imap_folders.py

# Email-Abruf testen
uv run debug_scripts/test_email_fetch.py
```

### Projektstruktur

```
fdsmp/
â”œâ”€â”€ main.py              # Hauptskript
â”œâ”€â”€ email_client.py      # IMAP-Operationen
â”œâ”€â”€ spam_classifier.py   # LLM-Klassifikation
â”œâ”€â”€ text_extractor.py    # Email-Text-Extraktion
â”œâ”€â”€ extract_emails.py    # Utility fÃ¼r Spam-Beispiele
â”œâ”€â”€ spam.json           # Few-Shot Spam-Beispiele
â”œâ”€â”€ debug_scripts/      # Debug-Tools
â”œâ”€â”€ data/               # Extrahierte Emails
â””â”€â”€ CLAUDE.md          # Entwickler-Dokumentation
```

## License

MIT License
